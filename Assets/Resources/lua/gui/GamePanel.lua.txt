---@class 游戏界面
GamePanel = GamePanel or {}
local _M = GamePanel

function _M:__init__()
    _M:InitView()
    _M:Main()
end

function _M:InitView()
    self.gameObject = UnityEngine.GameObject.Find("Canvas/Root_Panel/GamePanel").gameObject
    self.transform = self.gameObject.transform
    local transform = self.transform

    --

    self.Image_bg = self.transform:Find("$bg"):GetComponent("Image")
    self.Button_Button_back = self.transform:Find("$Button_back"):GetComponent("Button")
    self.Image_Button_back = self.transform:Find("$Button_back"):GetComponent("Image")
    self.Text_score = self.transform:Find("$score"):GetComponent("Text")
    self.Text_currentState = self.transform:Find("$currentState"):GetComponent("Text")
    self.game = self.transform:Find("$game")
    self.Image_item = self.transform:Find("$game/$item"):GetComponent("Image")
    self.Image_Image_name = self.transform:Find("$game/$item/$Image_name"):GetComponent("Image")
    self.Text_Text_name = self.transform:Find("$game/$item/$Text_name"):GetComponent("Text")
    self.Text_Text_attack = self.transform:Find("$game/$item/$Text_attack"):GetComponent("Text")
    self.Text_Text_defense = self.transform:Find("$game/$item/$Text_defense"):GetComponent("Text")
    self.Text_Text_hp = self.transform:Find("$game/$item/$Text_hp"):GetComponent("Text")
    self.Slider_taskTime = self.transform:Find("$Slider_taskTime"):GetComponent("Slider")
    self.Image_Background_Slider_taskTime =
        self.transform:Find("$Slider_taskTime/$Background_Slider_taskTime"):GetComponent("Image")
    self.Image_Fill_Slider_taskTime =
        self.transform:Find("$Slider_taskTime/Fill Area/$Fill_Slider_taskTime"):GetComponent("Image")
    self.Text_Text_taskTime = self.transform:Find("$Slider_taskTime/$Text_taskTime"):GetComponent("Text")
    self.Image_day_night = self.transform:Find("$day_night"):GetComponent("Image")
    self.Image_Image_day = self.transform:Find("$day_night/$Image_day"):GetComponent("Image")
    self.Image_Image_night = self.transform:Find("$day_night/$Image_night"):GetComponent("Image")
    self.Text_Text_day_night = self.transform:Find("$day_night/$Text_day_night"):GetComponent("Text")
    self.ResultPanel = self.transform:Find("$ResultPanel")
    self.Button_Button_replay = self.transform:Find("$ResultPanel/$Button_replay"):GetComponent("Button")
    self.Image_Button_replay = self.transform:Find("$ResultPanel/$Button_replay"):GetComponent("Image")

    --
end

function _M:Open()
    self.gameObject:SetActive(true)
    -- AudioManager.AudioSource_bgm_game:Play()
    _M:Start()
end

function _M:Close()
    self.gameObject:SetActive(false)
    -- AudioManager.AudioSource_bgm_game:Stop()
end

function _M:Main()
    self:InitData()
    self:AddListener()
    -- self:Start()
end

function _M:AddListener()
    UnityEngine.EventTriggerListener.Get(self.Button_Button_back.gameObject, nil).onClick = function()
        self:Close()
        MenuPanel:Open()
    end

    UnityEngine.EventTriggerListener.Get(self.Button_Button_replay.gameObject, nil).onClick = function()
        self:Start()
    end

    UnityEngine.EventTriggerListener.Get(self.Image_day_night.gameObject, nil).onClick = function()
        print(123)
        SB.state = 1
        self.Image_day_night.gameObject:SetActive(false)
    end
end

function _M:Clear()
    functions.SetActiveAllChildren(self.parent, false)
end

function _M:InitData()
    GamePanel.parent = self.game.transform
    GamePanel.prefab = self.parent.transform:GetChild(0).gameObject
end

function _M:Start()
    print_t("GamePanel:Start()")
    self:Clear()

    Player:CreatePlayer()

    SB.state = 1
    SB.totalStep = 0
    self.currentState = 1
    self.totalNumbers = 3

    self:RefreshState()

    self.isMove = false
    self.score = 0

    self:InitUI()
end

-- 刷新UI
function _M:InitUI()
    self.ResultPanel.gameObject:SetActive(false)

    self.Image_day_night.gameObject:SetActive(false)
end

-- 移动
function _M:Move(direction)
    if SB.state <= 0 then
        return
    end

    if direction.y > 0 then
        GamePanel:Up()
    elseif direction.y < 0 then
        GamePanel:Down()
    elseif direction.x < 0 then
        GamePanel:Left()
    elseif direction.x > 0 then
        GamePanel:Right()
    end
end

-- 左移
function _M:Left()
    for y = 1, SB.row, 1 do
        for x = 2, SB.col, 1 do
            local item = SB.list[y][x]
            if type(item) == "table" and type(item.Move) == "function" then
                self.isMove = item:Move({x = -1, y = 0})
            end
        end
    end
    Player:RandomCreate({x = SB.col, time = 0.4})
end

-- 右移
function _M:Right()
    for y = 1, SB.row, 1 do
        for x = SB.col - 1, 1, -1 do
            local item = SB.list[y][x]
            if type(item) == "table" and type(item.Move) == "function" then
                self.isMove = item:Move({x = 1, y = 0})
            end
        end
    end
    Player:RandomCreate({x = 1, time = 0.4})
end

-- 上移
function _M:Up()
    for x = 1, SB.col, 1 do
        for y = SB.row - 1, 1, -1 do
            local item = SB.list[y][x]
            if type(item) == "table" and type(item.Move) == "function" then
                self.isMove = item:Move({x = 0, y = 1})
            end
        end
    end
    Player:RandomCreate({y = 1, time = 0.4})
end

-- 下移
function _M:Down()
    for x = 1, SB.col, 1 do
        for y = 2, SB.row, 1 do
            local item = SB.list[y][x]
            if type(item) == "table" and type(item.Move) == "function" then
                self.isMove = item:Move({x = 0, y = -1})
            end
        end
    end
    Player:RandomCreate({y = SB.row, time = 0.4})
end

function _M:RefreshState()
    if self.currentState > 0 then
        self.Text_currentState.text = math.abs(self.currentState)
        self.Slider_taskTime.value = math.abs(self.currentState / self.totalNumbers)
        self.Image_Background_Slider_taskTime.color = Color.HexToRGBA("FFFFFF")
        self.Image_Fill_Slider_taskTime.color = Color.HexToRGBA("FFFFFF")
    else
        self.Text_currentState.text = math.abs(self.currentState)
        GamePanel.Slider_taskTime.value = math.abs(self.currentState / self.totalNumbers)
        self.Image_Background_Slider_taskTime.color = Color.HexToRGBA("FF0000")
        self.Image_Fill_Slider_taskTime.color = Color.HexToRGBA("FF0000")
    end
end

-- 10步杀一人
function _M:NextState()
    SB.totalStep = SB.totalStep + 1

    self.currentState = self.currentState + self.currentState/math.abs(self.currentState)
    if math.abs(self.currentState) >= self.totalNumbers then
        self.currentState = -self.currentState/math.abs(self.currentState)
        self:ChangeDayNight(self.currentState)
    end

    self:RefreshState()
end

function _M:ChangeDayNight(index)
    SB.state = 0

    if index > 0 then
        self.Image_bg.color = Color.HexToRGBA("DCDCDC")
    elseif index < 0 then
        self.Image_bg.color = Color.HexToRGBA("323232")
    end

    self.Image_day_night.gameObject:SetActive(true)
    self.Image_Image_day.gameObject:SetActive(index > 0)
    self.Image_Image_night.gameObject:SetActive(index < 0)
end

-- function _M:RefreshDayNight(index)
--     SB.state = 0

--     if index > 0 then
--         self.Image_bg.color = Color.HexToRGBA("DCDCDC")
--     elseif index < 0 then
--         self.Image_bg.color = Color.HexToRGBA("323232")
--     end

--     self.Image_day_night.gameObject:SetActive(true)
--     self.Image_Image_day.gameObject:SetActive(index > 0)
--     self.Image_Image_night.gameObject:SetActive(index < 0)
-- end

_M:__init__()
